#!/bin/zsh

# zmodload zsh/zprof

export ZSH="/usr/share/oh-my-zsh"
export ZSH_HOME="/usr/share/zsh"
export LANG=en_GB.UTF-8
export SD_ROOT="$HOME/t/dotfiles/sd"

ZSH_THEME="craigfe"

# Use Vi mode
bindkey -v

export PATH="$HOME/.local/bin:$HOME/.scripts:$PATH:$(ruby -e 'puts Gem.user_dir')/bin:$HOME/.yarn/bin"

COMPLETION_WAITING_DOTS="false"

# Don't mark untracked files as dirty
DISABLE_UNTRACKED_FILES_DIRTY="true"

plugins=(git vi-mode ssh-agent)

source $ZSH/oh-my-zsh.sh
source $ZSH_HOME/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
source $ZSH_HOME/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
source $HOME/.aliases
[ -f $HOME/.shortcuts/out/shell ] && source $HOME/.shortcuts/out/shell

# User configuration

# Preferred editor for local and remote sessions
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
  # export EDITOR="emacsclient --alternate-editor='emacs' --no-wait --create-frame"
fi

# ssh
export SSH_KEY_PATH="~/.ssh/rsa_id"

PROMPT_EOL_MARK=" â€¢"

# Python virtual environment configuration
export WORKON_HOME=$HOME/.virtualenvs
export PROJECT_HOME=$HOME/repos
export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3
export VIRTUALENVWRAPPER_SCRIPT=$HOME/.local/bin/virtualenvwrapper.sh
# source $HOME/.local/bin/virtualenvwrapper_lazy.sh

# Use the Vi navigation keys in menu completion
zstyle ':completion:*' menu select
zmodload zsh/complist

bindkey -M menuselect 'h' vi-backward-char
bindkey -M menuselect 'k' vi-up-line-or-history
bindkey -M menuselect 'l' vi-forward-char
bindkey -M menuselect 'j' vi-down-line-or-history

bindkey '^[[[SE' autosuggest-execute

bindkey -s '^g' 'projectgoto\n'

# Jump (https://github.com/gsamokovarov/jump)
eval "$(jump shell)"

# OPAM configuration
. /home/craigfe/.opam/opam-init/init.zsh > /dev/null 2> /dev/null || true

# AWS credentials
# . ~/.aws/get_credentials.sh

# Travis configuration
# [ -f /home/craigfe/.travis/travis.sh ] && source /home/craigfe/.travis/travis.sh

fh() {
    print -z $(history |\
                   fzf --no-sort --tac |\
                   sed -E 's/ *[0-9]*\*? *//; s/\\/\\\\/g')
}

ch() {
    local cols sep google_history open
    cols=$(( COLUMNS / 3 ))
    sep='{::}'

    if [ "$(uname)" = "Darwin" ]; then
        google_history="$HOME/Library/Application Support/Google/Chrome/Default/History"
        open=open
    else
        google_history="$HOME/.config/google-chrome/Default/History"
        open=xdg-open
    fi
    cp -f "$google_history" /tmp/h
    sqlite3 -separator $sep /tmp/h \
            "select substr(title, 1, $cols), url
     from urls order by last_visit_time desc" |
        awk -F $sep '{printf "%-'$cols's  \x1b[36m%s\x1b[m\n", $1, $2}' |
        fzf --ansi --multi | sed 's#.*\(https*://\)#\1#' | xargs $open > /dev/null 2> /dev/null
}

# Set up Nix package manager
[ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ] && . "$HOME/.nix-profile/etc/profile.d/nix.sh"
unset NIX_REMOTE # TODO: work out what keeps setting this

# Set up Node Version Manager
export NVM_DIR="$HOME/.nvm"                            # You can change this if you want.
export NVM_SOURCE="/usr/share/nvm"                     # The AUR package installs it to here.
[ -s "$NVM_SOURCE/nvm.sh" ] && . "$NVM_SOURCE/nvm.sh"  # Load NVM
source /usr/share/nvm/init-nvm.sh

# Oskel configuration
export PATH="$PATH:$HOME/t/oskel/_build/install/default/bin"
export OSKEL_FULL_NAME="Craig Ferguson"
export OSKEL_EMAIL="me@craigfe.io"
export OSKEL_GITHUB_ORG="CraigFe"
export OSKEL_OCAMLFORMAT_OPTIONS="parse-docstrings=true,break-infix=fit-or-vertical,module-item-spacing=compact"

export PATH="$HOME/.pyenv/shims:$PATH:$HOME/t/dune-release/_build/install/default/bin"

## History command configuration
setopt extended_history       # record timestamp of command in HISTFILE
setopt hist_expire_dups_first # delete duplicates first when HISTFILE size exceeds HISTSIZE
setopt hist_ignore_dups       # ignore duplicated commands history list
setopt hist_ignore_space      # ignore commands that start with space
setopt hist_verify            # show command with history expansion to user before running it
setopt share_history          # share command history data

PATH="/home/craigfe/perl5/bin${PATH:+:${PATH}}"; export PATH;
PERL5LIB="/home/craigfe/perl5/lib/perl5${PERL5LIB:+:${PERL5LIB}}"; export PERL5LIB;
PERL_LOCAL_LIB_ROOT="/home/craigfe/perl5${PERL_LOCAL_LIB_ROOT:+:${PERL_LOCAL_LIB_ROOT}}"; export PERL_LOCAL_LIB_ROOT;
PERL_MB_OPT="--install_base \"/home/craigfe/perl5\""; export PERL_MB_OPT;
PERL_MM_OPT="INSTALL_BASE=/home/craigfe/perl5"; export PERL_MM_OPT;

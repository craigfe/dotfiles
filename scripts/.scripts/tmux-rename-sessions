#!/usr/bin/env python3
"""Rename tmux sessions using Claude Haiku to generate descriptive names based
on terminal context. Auto-named sessions are suffixed with '*' so they can be
re-renamed on subsequent runs. Manually-named sessions are left alone."""

import os
import subprocess
from concurrent.futures import ThreadPoolExecutor, as_completed

# Ensure Homebrew binaries are available when invoked from tmux run-shell,
# which has a minimal PATH. Also strip CLAUDECODE so the claude CLI runs in
# non-interactive mode even when invoked from within a Claude Code session.
_env = {k: v for k, v in os.environ.items() if k != "CLAUDECODE"}
_env["PATH"] = f"/opt/homebrew/bin:{os.path.expanduser('~/.local/bin')}:{_env.get('PATH', '')}"

PROMPT = """\
Based on this terminal context, suggest a short name for this tmux session.

Current command and path: {pane_info}

Last 20 lines of terminal:
{pane_content}

Rules:
- Reply with ONLY the session name, nothing else
- 1-2 words, lowercase, hyphens instead of spaces
- Use the project/repo name if visible (e.g. "dotfiles", "wearedev")
- Use the task if clear (e.g. "self-review", "coding-challenge")
- Use the directory basename as fallback
- Max 20 characters"""


def tmux(*args: str) -> str:
    result = subprocess.run(
        ["tmux", *args], capture_output=True, text=True, timeout=5, env=_env,
    )
    return result.stdout.strip()


def ask_haiku(prompt: str) -> str:
    """Call claude CLI with prompt via stdin to avoid shell escaping issues."""
    result = subprocess.run(
        ["claude", "--model", "haiku", "--print", "--max-turns", "1"],
        input=prompt, capture_output=True, text=True, timeout=30, env=_env,
    )
    return result.stdout.strip().lower().replace(" ", "-")[:20]


def suggest_name(session: str) -> tuple[str, str | None]:
    """Returns (session_id, suggested_name) or (session_id, None) on failure."""
    try:
        pane_info = tmux(
            "list-panes", "-t", session,
            "-F", "#{pane_current_command} #{pane_current_path}",
        ).split("\n")[0]

        pane_content = "\n".join(
            tmux("capture-pane", "-t", session, "-p").split("\n")[-20:]
        )

        prompt = PROMPT.format(pane_info=pane_info, pane_content=pane_content)
        name = ask_haiku(prompt)
        name = name.strip("\"'`.,! ")
        return (session, name) if name else (session, None)
    except Exception as e:
        print(f"  {session}: error: {e}")
        return (session, None)


SUFFIX = "*"


def is_auto_named(name: str) -> bool:
    return name.isdigit() or name.endswith(SUFFIX)


def main():
    sessions = tmux("list-sessions", "-F", "#{session_name}").split("\n")
    targets = [s for s in sessions if is_auto_named(s)]

    if not targets:
        print("No sessions to rename.")
        return

    print(f"Renaming {len(targets)} session(s): {', '.join(targets)}")

    # Track names that are taken (strip suffix from auto-names so we
    # deduplicate against the base name, not "foo*")
    claimed = {s.removesuffix(SUFFIX) for s in sessions if not is_auto_named(s)}

    def unique_name(base: str) -> str:
        name = base
        i = 2
        while name in claimed:
            name = f"{base}-{i}"
            i += 1
        claimed.add(name)
        return name

    # Run haiku calls concurrently (stdin piping avoids shell escaping issues)
    with ThreadPoolExecutor(max_workers=6) as pool:
        futures = {pool.submit(suggest_name, s): s for s in targets}

        for future in as_completed(futures):
            session, name = future.result()
            if name:
                name = unique_name(name)
                display_name = f"{name}{SUFFIX}"
                try:
                    tmux("rename-session", "-t", session, display_name)
                    print(f"  {session} -> {display_name}")
                except Exception as e:
                    print(f"  {session} -> {display_name}: rename failed: {e}")
            else:
                print(f"  {session}: skipped (no suggestion)")


if __name__ == "__main__":
    main()
